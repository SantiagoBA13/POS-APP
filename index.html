<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Master - Sistema Integrado</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            /* MODO NOCHE */
            --bg-body: #0f172a;
            --bg-gradient: radial-gradient(circle at 90% 10%, #1e293b 0%, #0f172a 100%);
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent-color: #3b82f6;
            --card-hover: rgba(255, 255, 255, 0.05);
        }

        body.light-mode {
            /* MODO D√çA */
            --bg-body: #f1f5f9;
            --bg-gradient: linear-gradient(135deg, #e2e8f0 0%, #f8fafc 100%);
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(203, 213, 225, 0.8);
            --text-main: #0f172a;
            --text-muted: #475569;
            --accent-color: #2563eb;
            --card-hover: white;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body); 
            background-image: var(--bg-gradient);
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
            user-select: none; 
            transition: all 0.5s ease;
        }

        .glass-panel { 
            background: var(--glass-bg); 
            backdrop-filter: blur(25px); 
            border: 1px solid var(--glass-border); 
            border-radius: 1.5rem; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .glass-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            transition: 0.2s;
            cursor: pointer;
        }
        .glass-btn:hover { background: var(--card-hover); transform: translateY(-2px); border-color: var(--accent-color); }
        .glass-btn:active { transform: scale(0.98); }

        .glass-input {
            background: rgba(0,0,0,0.1); 
            border: 1px solid var(--glass-border); 
            padding: 0.75rem 1rem; 
            border-radius: 0.75rem; 
            width: 100%; 
            outline: none; 
            color: inherit;
        }
        body.light-mode .glass-input { background: rgba(255,255,255,0.6); }
        .glass-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }

        .hide-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        .view-anim { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        dialog { 
            background: var(--bg-body); 
            color: var(--text-main); 
            border: 1px solid var(--glass-border); 
            border-radius: 1.5rem; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        dialog::backdrop { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }

        .glass-table { width: 100%; border-collapse: separate; border-spacing: 0 0.5rem; }
        .glass-table th { text-align: left; padding: 1rem; font-size: 0.75rem; opacity: 0.7; text-transform: uppercase; }
        .glass-table tr { background: var(--glass-bg); transition: 0.2s; }
        .glass-table tr:hover { background: var(--card-hover); }
        .glass-table td { padding: 1rem; }
        .glass-table td:first-child { border-radius: 0.75rem 0 0 0.75rem; }
        .glass-table td:last-child { border-radius: 0 0.75rem 0.75rem 0; }

        .tab-active { 
            border-bottom: 2px solid var(--accent-color); 
            color: var(--accent-color); 
            opacity: 1 !important;
        }

        #print-frame { position: absolute; width: 0; height: 0; border: none; visibility: hidden; }
        @media print { body * { visibility: hidden; } }
    </style>
</head>
<body class="flex flex-col">

    <div id="toast" class="fixed top-5 right-5 z-[100] glass-panel px-6 py-4 flex items-center gap-4 translate-x-[200%] transition-transform duration-500 border-l-4 border-blue-500 bg-slate-900 text-white shadow-2xl">
        <i id="toast-icon" class="ph ph-check-circle text-2xl text-blue-400"></i>
        <div><h4 id="toast-title" class="font-bold text-sm">Info</h4><p id="toast-msg" class="text-xs text-slate-400">...</p></div>
    </div>

    <div id="login-screen" class="fixed inset-0 z-[50] flex flex-col items-center justify-center bg-[#0f172a] view-anim" style="background-image: var(--bg-gradient);">
        <div class="mb-8 text-center flex flex-col items-center">
            <h1 id="login-brand" class="text-6xl font-black tracking-tighter mb-2 bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">POS MASTER</h1>
            <p class="text-dynamic-muted uppercase tracking-[0.4em] text-xs font-bold">V11.0 CONNECTED</p>
        </div>
        <div class="glass-panel p-10 w-full max-w-md">
            <div id="user-grid" class="grid grid-cols-2 gap-4 mb-6"></div>
            <div id="pin-container" class="hidden flex flex-col gap-6">
                <div class="text-center mb-2"><p class="text-sm opacity-60">Hola,</p><h3 id="login-user-name" class="text-2xl font-bold">Usuario</h3></div>
                <input type="password" id="login-pin" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code" class="glass-input text-center text-4xl tracking-[1em] font-bold h-20" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="resetLogin()" class="glass-btn py-4 rounded-xl opacity-60 hover:opacity-100">Atr√°s</button>
                    <button onclick="attemptLogin()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg">Acceder</button>
                </div>
            </div>
        </div>
    </div>

    <header id="main-header" class="hidden flex justify-between items-center px-6 py-3 glass-panel m-3 mb-0 rounded-2xl">
        <div class="flex items-center gap-4">
            <button onclick="nav('home')" class="hover:text-blue-400 transition transform hover:scale-105 flex items-center gap-3">
                <span id="app-brand-name" class="text-xl font-black tracking-tight">MI NEGOCIO</span>
            </button>
            <div class="h-6 w-[1px] bg-white/20"></div>
            <div><h2 id="clock-time" class="text-xl font-bold leading-none tabular-nums">00:00</h2><p id="clock-date" class="text-[10px] uppercase opacity-50 font-bold">...</p></div>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="toggleTheme()" class="w-10 h-10 rounded-full glass-btn flex items-center justify-center text-lg"><i id="theme-icon" class="ph-fill ph-moon"></i></button>
            <div onclick="location.reload()" class="flex items-center gap-3 glass-btn px-4 py-2 rounded-xl cursor-pointer group">
                <div class="text-right"><p id="header-user" class="text-sm font-bold">User</p><p id="header-role" class="text-[9px] uppercase opacity-50 font-bold">Role</p></div>
                <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 font-bold border border-blue-500/30"><i class="ph-bold ph-user"></i></div>
            </div>
        </div>
    </header>

    <main id="main-container" class="hidden flex-1 p-3 overflow-hidden relative">
        
        <div id="view-home" class="view-anim h-full w-full flex flex-col">
            <div class="grid grid-cols-4 grid-rows-3 gap-4 h-full w-full">
                <button onclick="nav('pos')" class="glass-btn rounded-3xl flex flex-col items-center justify-center gap-6 hover:scale-[1.01] transition duration-300 col-span-2 row-span-3 bg-blue-600/5 border-blue-500/20 group relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                    <i class="ph-duotone ph-cash-register text-8xl text-blue-400 group-hover:scale-110 transition duration-300 drop-shadow-lg"></i>
                    <div class="z-10 text-center"><span class="text-4xl font-bold block">Punto de Venta</span><span class="text-xs opacity-50 uppercase tracking-widest font-bold">Iniciar Cobro</span></div>
                </button>
                <button onclick="nav('inventory')" class="glass-btn p-6 rounded-3xl flex flex-col items-center justify-center gap-2 hover:scale-[1.02] transition col-span-1 row-span-1 group"><i class="ph-duotone ph-package text-5xl text-emerald-400 group-hover:scale-110 transition"></i><span class="text-lg font-bold">Inventario</span></button>
                <button onclick="nav('clients')" class="glass-btn p-6 rounded-3xl flex flex-col items-center justify-center gap-2 hover:scale-[1.02] transition col-span-1 row-span-1 group"><i class="ph-duotone ph-users text-5xl text-purple-400 group-hover:scale-110 transition"></i><span class="text-lg font-bold">Clientes</span></button>
                <button onclick="nav('reports')" class="glass-btn p-6 rounded-3xl flex flex-col items-center justify-center gap-2 hover:scale-[1.02] transition col-span-1 row-span-2 group"><i class="ph-duotone ph-chart-pie-slice text-6xl text-orange-400 group-hover:scale-110 transition"></i><span class="text-xl font-bold">Reportes</span></button>
                <button onclick="nav('settings')" class="glass-btn p-6 rounded-3xl flex flex-col items-center justify-center gap-2 hover:scale-[1.02] transition col-span-1 row-span-2 group"><i class="ph-duotone ph-gear text-6xl text-slate-400 group-hover:scale-110 transition"></i><span class="text-xl font-bold">Ajustes</span></button>
            </div>
        </div>

        <div id="view-pos" class="hidden view-anim h-full flex gap-3">
            <div class="flex-1 flex flex-col gap-3 h-full">
                <div class="flex gap-3 h-14 shrink-0">
                    <div class="relative flex-1 h-full">
                        <i class="ph-bold ph-barcode absolute left-5 top-4 opacity-50 text-2xl"></i>
                        <input type="text" id="pos-search" onkeydown="handleBarcode(event)" onkeyup="renderPOS()" placeholder="Escanear o buscar..." class="glass-input pl-14 rounded-2xl text-xl h-full shadow-lg font-bold" autofocus>
                    </div>
                    <div id="category-filters" class="flex gap-2 overflow-x-auto hide-scrollbar max-w-md h-full items-center px-1"></div>
                </div>
                <div id="pos-grid" class="flex-1 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 overflow-y-auto pr-1 pb-4 hide-scrollbar content-start"></div>
            </div>
            
            <div class="w-[420px] glass-panel flex flex-col overflow-hidden shrink-0 h-full border-l-4 border-blue-500/10">
                <div class="p-3 border-b border-white/5 shrink-0 flex gap-2">
                    <button onclick="openClientSelectionModal()" class="flex-1 glass-btn p-4 rounded-2xl flex justify-between items-center group bg-blue-500/5 hover:bg-blue-500/10">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400"><i class="ph-fill ph-user text-xl"></i></div>
                            <div class="text-left">
                                <p class="text-[10px] opacity-50 uppercase tracking-wider font-bold">Cliente Actual</p>
                                <p id="pos-client-name" class="font-bold text-sm truncate w-32">P√∫blico General</p>
                            </div>
                        </div>
                        <i class="ph-bold ph-caret-down opacity-50 group-hover:opacity-100"></i>
                    </button>
                    <button onclick="openClientAddModal()" class="glass-btn w-16 rounded-2xl flex items-center justify-center text-blue-400 hover:bg-blue-500 hover:text-white transition" title="Nuevo Cliente R√°pido"><i class="ph-bold ph-plus text-xl"></i></button>
                </div>
                
                <div id="pos-cart-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
                
                <div class="p-5 bg-white/5 border-t border-white/10 shrink-0 backdrop-blur-md">
                    <div class="flex justify-between text-sm opacity-60 mb-1 font-mono"><span>Subtotal</span><span id="lbl-subtotal">$0.00</span></div>
                    <div class="flex justify-between text-sm opacity-60 mb-3 font-mono"><span>Impuestos</span><span id="lbl-tax">$0.00</span></div>
                    <div class="flex justify-between items-end mb-6"><span class="font-bold text-xl tracking-tight">TOTAL</span><span id="lbl-total" class="text-5xl font-black text-blue-500 tracking-tighter tabular-nums">$0.00</span></div>
                    <div class="grid grid-cols-4 gap-3 h-16">
                        <button onclick="processQuotation()" class="glass-btn rounded-xl flex flex-col items-center justify-center text-orange-400 text-[10px] font-bold hover:bg-orange-500/10 border-orange-500/30"><i class="ph-bold ph-file-text text-2xl mb-1"></i>COTIZAR</button>
                        <button onclick="openPaymentModal()" class="col-span-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-2xl shadow-lg shadow-blue-500/30 tracking-wide flex items-center justify-center gap-2">COBRAR <i class="ph-bold ph-arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="hidden view-anim h-full flex flex-col gap-4">
            <div class="flex justify-between items-center gap-4">
                <h2 class="text-2xl font-bold">Inventario</h2>
                <div class="flex gap-2 flex-1 justify-end">
                    <button onclick="renderCatList(); document.getElementById('modal-category').showModal()" class="glass-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i class="ph-bold ph-tag"></i> Categor√≠as</button>
                    <div class="flex bg-white/5 p-1 rounded-xl">
                        <button onclick="invFilter='all';renderInventory()" class="px-4 py-2 rounded-lg text-xs font-bold hover:bg-white/10">Todo</button>
                        <button onclick="invFilter='low';renderInventory()" class="px-4 py-2 rounded-lg text-xs font-bold text-orange-400 hover:bg-orange-500/10">‚ö†Ô∏è Faltantes</button>
                        <button onclick="invFilter='top';renderInventory()" class="px-4 py-2 rounded-lg text-xs font-bold text-emerald-400 hover:bg-emerald-500/10">üî• M√°s Vendidos</button>
                    </div>
                    <input type="text" onkeyup="filterInventory(this.value)" placeholder="Buscar..." class="glass-input w-64 text-sm">
                    <button onclick="openProductModal()" class="bg-emerald-600 px-6 py-2 rounded-xl font-bold text-sm shadow-lg hover:bg-emerald-500 text-white flex items-center gap-2"><i class="ph-bold ph-plus"></i> Nuevo</button>
                </div>
            </div>
            <div class="glass-panel flex-1 overflow-hidden flex flex-col">
                <div class="overflow-y-auto flex-1 p-0 hide-scrollbar">
                    <table class="glass-table w-full text-sm">
                        <thead class="sticky top-0 bg-white/5 backdrop-blur-md z-10"><tr><th class="p-4 pl-6">Producto</th><th class="text-xs opacity-50 font-mono">C√≥digo</th><th>Categor√≠a</th><th class="text-center">Stock</th><th class="text-right">Costo</th><th class="text-right">Venta</th><th class="text-right pr-6">Acciones</th></tr></thead>
                        <tbody id="inventory-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-reports" class="hidden view-anim h-full flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Reportes y Caja</h2>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('import-input').click()" class="glass-btn px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2"><i class="ph-bold ph-upload-simple"></i> Importar JSON</button>
                    <input type="file" id="import-input" class="hidden" accept=".json" onchange="importDB(this)">
                    <button onclick="backupSmart()" class="glass-btn px-4 py-2 rounded-xl text-sm font-bold text-emerald-400 border-emerald-500/30 flex items-center gap-2"><i class="ph-bold ph-download-simple"></i> Exportar Datos</button>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-4 shrink-0">
                <div class="glass-panel p-5 bg-blue-500/5 border-l-4 border-blue-500"><p class="text-xs uppercase opacity-50 font-bold">Ventas Turno</p><h3 id="dash-sales-today" class="text-3xl font-black tabular-nums">$0.00</h3></div>
                <div class="glass-panel p-5 bg-orange-500/5 border-l-4 border-orange-500"><p class="text-xs uppercase opacity-50 font-bold">Fondo Inicial</p><h3 id="dash-start-cash" class="text-3xl font-black tabular-nums">$0.00</h3></div>
                <div class="glass-panel p-5 bg-purple-500/5 border-l-4 border-purple-500"><p class="text-xs uppercase opacity-50 font-bold">Transacciones</p><h3 id="dash-tx-count" class="text-3xl font-black tabular-nums">0</h3></div>
                <button onclick="performCashCut()" class="glass-panel p-5 hover:bg-red-500/10 text-left border-l-4 border-red-500 group transition flex flex-col justify-center cursor-pointer">
                    <p class="text-xs uppercase text-red-400 font-bold group-hover:text-red-300">Finalizar Turno</p>
                    <div class="flex justify-between items-center"><h3 class="text-2xl font-bold">Hacer Corte Z</h3><i class="ph-bold ph-receipt text-3xl text-red-400"></i></div>
                </button>
            </div>
            <div class="flex-1 grid grid-cols-3 gap-4 overflow-hidden pb-2">
                <div class="glass-panel p-4 col-span-2 flex flex-col"><h4 class="font-bold mb-4 opacity-50">Rendimiento de Ventas</h4><div class="flex-1 relative"><canvas id="salesChart"></canvas></div></div>
                <div class="glass-panel p-4 flex flex-col"><h4 class="font-bold mb-4 opacity-50">Log Reciente</h4><div id="recent-sales-log" class="flex-1 overflow-y-auto space-y-2 pr-2 hide-scrollbar text-xs"></div></div>
            </div>
        </div>

        <div id="view-settings" class="hidden view-anim h-full overflow-y-auto pb-20">
            <h2 class="text-2xl font-bold mb-6">Configuraci√≥n</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-panel p-6 space-y-4">
                    <h3 class="font-bold border-b border-white/10 pb-2 mb-4">Negocio</h3>
                    <div class="flex items-center gap-4 bg-white/5 p-3 rounded-xl"><img id="settings-logo-preview" class="w-16 h-16 object-contain bg-black/20 rounded-lg"><div class="flex-1"><label class="text-xs uppercase opacity-50 block mb-1 font-bold">Logo Ticket</label><input type="file" accept="image/*" onchange="processLogoUpload(this)" class="text-xs w-full"></div></div>
                    <div class="grid grid-cols-2 gap-3"><div><label class="text-xs opacity-50 ml-1 font-bold">Nombre</label><input id="cfg-company" class="glass-input"></div><div><label class="text-xs opacity-50 ml-1 font-bold">Tel√©fono</label><input id="cfg-phone" class="glass-input"></div></div>
                    <div><label class="text-xs opacity-50 ml-1 font-bold">Direcci√≥n</label><input id="cfg-address" class="glass-input"></div>
                    <div><label class="text-xs opacity-50 ml-1 font-bold">Mensaje Ticket</label><textarea id="cfg-footer" class="glass-input h-16"></textarea></div>
                    <div class="grid grid-cols-2 gap-3"><div><label class="text-xs opacity-50 ml-1 font-bold">Impuesto %</label><input type="number" id="cfg-tax" class="glass-input"></div></div>
                    <button onclick="saveSettings()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold mt-2 text-white shadow-lg">Guardar Cambios</button>
                </div>
                <div class="space-y-6">
                    <div class="glass-panel p-6 border-l-4 border-orange-500">
                        <h3 class="font-bold mb-2">Importar Productos</h3>
                        <div class="flex gap-2">
                            <button onclick="downloadTemplate()" class="glass-btn flex-1 py-2 text-xs">Descargar Plantilla CSV</button>
                            <button onclick="document.getElementById('csv-input').click()" class="bg-orange-600 hover:bg-orange-500 text-white flex-1 py-2 rounded-lg text-xs font-bold">Subir CSV</button>
                            <input type="file" id="csv-input" accept=".csv" class="hidden" onchange="processCSV(this)">
                        </div>
                    </div>
                    <div class="glass-panel p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold border-b border-white/10 pb-2">Usuarios</h3>
                            <button onclick="openUserModal()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded font-bold">+ Nuevo</button>
                        </div>
                        <div id="users-list-mini" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
                    </div>
                    <div class="glass-panel p-6">
                        <h3 class="font-bold border-b border-white/10 pb-2 mb-4">Acerca de</h3>
                        <button onclick="document.getElementById('modal-about').showModal()" class="glass-btn w-full py-2 rounded-lg text-xs font-bold">Ver Informaci√≥n del Desarrollador</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-clients" class="hidden view-anim h-full flex flex-col gap-4">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">Clientes</h2><button onclick="openClientAddModal()" class="bg-purple-600 px-4 py-2 rounded-lg font-bold text-sm shadow-lg hover:bg-purple-500 text-white">+ Cliente</button></div>
            <div id="clients-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto pb-20"></div>
        </div>
    </main>

    <dialog id="modal-shift-open" class="backdrop:bg-black/90"><div class="p-8 w-[400px] text-center"><div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-white"><i class="ph-bold ph-currency-dollar"></i></div><h2 class="text-2xl font-bold mb-2">Apertura de Caja</h2><p class="opacity-60 text-sm mb-6">Fondo inicial del turno:</p><input type="number" id="shift-start-amount" class="glass-input text-center text-3xl font-bold mb-6 h-16" placeholder="$0.00"><button onclick="startShift()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold text-lg shadow-lg">Abrir Turno</button></div></dialog>
    <dialog id="modal-shift-close"><div class="p-8 w-[500px]"><h2 class="text-2xl font-bold mb-6 text-center border-b border-white/10 pb-4">Cierre de Turno (Corte Z)</h2><div class="space-y-4 mb-6 text-sm"><div class="flex justify-between p-3 bg-white/5 rounded-lg"><span>Fondo Inicial:</span><span class="font-bold" id="cut-start">$0.00</span></div><div class="flex justify-between p-3 bg-white/5 rounded-lg"><span>Ventas Efectivo:</span><span class="font-bold text-emerald-400" id="cut-sales">$0.00</span></div><div class="flex justify-between p-3 bg-white/5 rounded-lg border border-blue-500/30"><span class="font-bold text-lg">Total Esperado:</span><span class="font-bold text-lg text-blue-400" id="cut-expected">$0.00</span></div></div><label class="text-xs opacity-50 uppercase font-bold block mb-2">Dinero Contado en Caja:</label><input type="number" id="cut-counted" class="glass-input text-2xl font-bold mb-4" placeholder="$0.00" oninput="calcDiff()"><div id="cut-diff-box" class="text-center p-2 rounded-lg font-bold text-sm hidden mb-4">Diferencia: $0.00</div><div class="flex gap-3"><button onclick="document.getElementById('modal-shift-close').close()" class="glass-btn flex-1 py-3 rounded-xl font-bold">Cancelar</button><button onclick="confirmCut()" class="flex-1 bg-red-600 hover:bg-red-500 text-white py-3 rounded-xl font-bold shadow-lg">Cerrar Turno</button></div></div></dialog>
    <dialog id="modal-payment"><div class="p-6 w-[500px]"><h2 class="text-center text-sm opacity-50 mb-1 font-bold uppercase">Total a Pagar</h2><h2 id="modal-pay-total" class="text-6xl font-black text-center mb-8 text-white tracking-tighter">$0.00</h2><div class="grid grid-cols-2 gap-3 mb-6"><button onclick="setPayMethod('Efectivo')" id="btn-pay-Efectivo" class="glass-btn p-4 rounded-xl border-2 border-transparent hover:border-blue-500 flex flex-col items-center gap-2"><i class="ph-duotone ph-money text-3xl text-green-400"></i><span class="font-bold">Efectivo</span></button><button onclick="setPayMethod('Tarjeta')" id="btn-pay-Tarjeta" class="glass-btn p-4 rounded-xl border-2 border-transparent hover:border-blue-500 flex flex-col items-center gap-2"><i class="ph-duotone ph-credit-card text-3xl text-purple-400"></i><span class="font-bold">Tarjeta</span></button><button onclick="setPayMethod('Transferencia')" id="btn-pay-Transferencia" class="glass-btn p-4 rounded-xl border-2 border-transparent hover:border-blue-500 flex flex-col items-center gap-2"><i class="ph-duotone ph-bank text-3xl text-blue-400"></i><span class="font-bold">Transferencia</span></button><button onclick="setPayMethod('Cr√©dito')" id="btn-pay-Cr√©dito" class="glass-btn p-4 rounded-xl border-2 border-transparent hover:border-blue-500 flex flex-col items-center gap-2 relative"><i class="ph-duotone ph-notebook text-3xl text-orange-400"></i><span class="font-bold">Cr√©dito</span></button></div><div class="flex gap-3"><button onclick="document.getElementById('modal-payment').close()" class="glass-btn flex-1 py-3 rounded-xl font-bold">Cancelar</button><button onclick="confirmSale()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold text-lg shadow-lg">PAGAR</button></div></div></dialog>
    
    <dialog id="modal-client-select">
        <div class="p-6 w-[400px] h-[500px] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl">Seleccionar Cliente</h3>
                <button onclick="openClientAddModal()" class="text-blue-400 text-sm font-bold hover:bg-blue-500/10 px-2 py-1 rounded">+ Nuevo</button>
            </div>
            <input placeholder="Buscar cliente..." onkeyup="renderClientSelect(this.value)" class="glass-input mb-4 font-bold">
            <div id="client-select-list" class="flex-1 overflow-y-auto space-y-2 hide-scrollbar pr-2"></div>
            <button onclick="document.getElementById('modal-client-select').close()" class="mt-4 glass-btn py-3 rounded-xl font-bold">Cancelar</button>
        </div>
    </dialog>
    
    <dialog id="modal-client-add"><div class="p-6 w-[400px]"><h3 class="font-bold text-xl mb-4">Nuevo Cliente</h3><form onsubmit="submitNewClient(event)" class="space-y-3"><input type="text" id="new-client-name" class="glass-input" placeholder="Nombre" required><input type="text" id="new-client-phone" class="glass-input" placeholder="Tel√©fono"><input type="email" id="new-client-email" class="glass-input" placeholder="Email"><button type="submit" class="w-full bg-purple-600 py-3 rounded-xl font-bold mt-2 text-white shadow-lg">Guardar y Usar</button>
<!-- === MONEDA Y DECIMALES === -->
<div class="grid grid-cols-3 gap-3 mt-4">
  <div>
    <label class="text-xs opacity-50 font-bold">Moneda</label>
    <select id="cfg-currency" class="glass-input">
      <option value="MXN">MXN</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
    </select>
  </div>
  <div>
    <label class="text-xs opacity-50 font-bold">Decimales</label>
    <select id="cfg-decimals" class="glass-input">
      <option value="0">0</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </div>
  <div>
    <label class="text-xs opacity-50 font-bold">Formato</label>
    <select id="cfg-locale" class="glass-input">
      <option value="es-MX">M√©xico</option>
      <option value="en-US">USA</option>
      <option value="de-DE">Europa</option>
    </select>
  </div>
</div>

</form></div></dialog>
    <dialog id="modal-product"><div class="p-6 w-[400px]"><h3 id="modal-prod-title" class="font-bold text-xl mb-4">Producto</h3><form onsubmit="saveProductForm(event)" class="space-y-3"><input type="hidden" id="inp-prod-id"><input id="inp-prod-name" class="glass-input" placeholder="Nombre" required><input id="inp-prod-code" class="glass-input" placeholder="C√≥digo Barras"><select id="inp-prod-cat" class="glass-input bg-slate-800"></select><div class="grid grid-cols-2 gap-3"><input type="number" id="inp-prod-price" class="glass-input" placeholder="Precio Venta" required><input type="number" id="inp-prod-stock" class="glass-input" placeholder="Stock" required></div><button type="submit" class="w-full bg-emerald-600 py-3 rounded-xl font-bold mt-2 text-white shadow-lg">Guardar</button></form></div></dialog>
    
    <dialog id="modal-client-profile"><div class="p-0 w-[600px] h-[700px] flex flex-col overflow-hidden bg-[#0f172a]">
        <div class="p-6 bg-black/20 border-b border-white/5 flex justify-between items-start">
            <div>
                <div class="flex items-center gap-3">
                    <h3 id="profile-client-name" class="text-2xl font-bold">Cliente</h3>
                    <button onclick="openEditClientModal()" class="text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded text-blue-300 flex items-center gap-1"><i class="ph-bold ph-pencil-simple"></i> Editar</button>
                </div>
                <p id="profile-client-phone" class="text-sm opacity-50 font-mono">--</p>
                <p id="profile-client-email" class="text-xs opacity-30 mt-1">--</p>
            </div>
            <div class="text-right"><span class="text-[10px] uppercase opacity-50 block font-bold">Deuda</span><span id="profile-client-debt" class="text-3xl font-black tabular-nums">$0.00</span></div>
        </div>
        <div class="p-3 bg-white/5 flex gap-2">
            <button onclick="sendWhatsApp('promo')" class="glass-btn flex-1 py-2 text-xs flex items-center justify-center gap-2 font-bold"><i class="ph-bold ph-whatsapp-logo text-emerald-400"></i> Promo</button>
            <button onclick="sendWhatsApp('debt')" class="glass-btn flex-1 py-2 text-xs flex items-center justify-center gap-2 text-rose-300 border-rose-500/30 font-bold"><i class="ph-bold ph-warning-circle"></i> Cobrar</button>
        </div>
        <div class="flex border-b border-white/5 border-t border-white/5">
            <button onclick="switchTab('sales')" id="tab-sales" class="flex-1 py-3 text-sm font-bold opacity-50 hover:opacity-100 border-b-2 border-transparent">Historial</button>
            <button onclick="switchTab('quotes')" id="tab-quotes" class="flex-1 py-3 text-sm font-bold opacity-50 hover:opacity-100 border-b-2 border-transparent">Cotizaciones</button>
            <button onclick="switchTab('credit')" id="tab-credit" class="flex-1 py-3 text-sm font-bold opacity-50 hover:opacity-100 border-b-2 border-transparent">Abonos</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-white/5">
            <div id="content-sales" class="space-y-2"></div>
            <div id="content-quotes" class="hidden space-y-2"></div>
            <div id="content-credit" class="hidden p-4 text-center">
                <p class="mb-4 opacity-50">Gestionar Saldo</p>
                <input type="number" id="credit-amount" placeholder="Monto" class="glass-input text-center text-2xl font-bold mb-4">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="adjustCredit('pay')" class="bg-emerald-600 py-3 rounded-xl font-bold text-white shadow-lg">Registrar Abono</button>
                    <button onclick="adjustCredit('add')" class="glass-btn py-3 rounded-xl text-rose-400 font-bold">Agregar Deuda</button>
                </div>
            </div>
        </div>
        <div class="p-4"><button onclick="document.getElementById('modal-client-profile').close()" class="glass-btn w-full py-3 rounded-xl font-bold">Cerrar</button></div>
    </div></dialog>

    <dialog id="modal-client-edit">
        <div class="p-6 w-[400px]">
            <h3 class="font-bold text-xl mb-4">Editar Cliente</h3>
            <form onsubmit="saveEditClient(event)" class="space-y-3">
                <div><label class="text-xs opacity-50 ml-1">Nombre</label><input id="edit-client-name" class="glass-input" required></div>
                <div><label class="text-xs opacity-50 ml-1">Tel√©fono</label><input id="edit-client-phone" class="glass-input"></div>
                <div><label class="text-xs opacity-50 ml-1">Email</label><input id="edit-client-email" class="glass-input"></div>
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="document.getElementById('modal-client-edit').close()" class="glass-btn flex-1 py-2 rounded-xl">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white flex-1 py-2 rounded-xl font-bold shadow-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </dialog>
    
    <dialog id="modal-category"><div class="p-6 w-[350px]"><h3 class="font-bold mb-4">Categor√≠as</h3><div class="flex gap-2 mb-4"><input id="new-cat-name" class="glass-input" placeholder="Nueva..."><button onclick="addNewCategory()" class="bg-blue-600 px-3 rounded-lg font-bold text-white">+</button></div><div id="cat-list-ui" class="max-h-60 overflow-y-auto space-y-2"></div><button onclick="document.getElementById('modal-category').close()" class="glass-btn w-full mt-4 py-2 rounded-lg font-bold">Cerrar</button></div></dialog>
    <dialog id="modal-setup"><div class="p-8 w-[450px]"><h2 class="text-2xl font-bold text-center mb-6">Configuraci√≥n Inicial</h2><form onsubmit="saveWizard(event)" class="space-y-4"><input id="wiz-name" class="glass-input" placeholder="Nombre Negocio" required><input id="wiz-addr" class="glass-input" placeholder="Direcci√≥n"><input id="wiz-phone" class="glass-input" placeholder="Tel√©fono"><button type="submit" class="w-full bg-blue-600 py-3 rounded-xl font-bold mt-2 text-white shadow-lg">Comenzar</button></form></div></dialog>
    <dialog id="modal-user"><div class="p-6 w-[350px]"><h3 id="modal-user-title" class="font-bold mb-4">Usuario</h3><form onsubmit="submitUserForm(event)" class="space-y-3"><input type="hidden" id="inp-user-id"><input id="inp-user-name" class="glass-input" placeholder="Nombre" required><select id="inp-user-role" class="glass-input bg-slate-800"><option value="admin">Admin</option><option value="cajero">Cajero</option></select><input id="inp-user-pin" class="glass-input text-center font-bold tracking-widest" placeholder="PIN (4)" maxlength="4" required><button type="submit" class="w-full bg-rose-600 py-3 rounded-xl font-bold text-white shadow-lg">Guardar</button></form></div></dialog>
    
    <dialog id="modal-about"><div class="p-8 w-[400px] text-center">
        <h2 class="text-2xl font-bold mb-4">Informaci√≥n del Desarrollador</h2>
        <div id="dev-info-content" class="text-left text-sm opacity-80 space-y-2 mb-6 bg-white/5 p-4 rounded-xl"></div>
        <button onclick="document.getElementById('modal-about').close()" class="glass-btn w-full py-2 rounded-lg font-bold">Cerrar</button>
    </div></dialog>

    <script>
        // --- 1. CONFIGURACI√ìN DEL DESARROLLADOR ---
        const DEV_INFO = {
            name: "Y. SANTIAGO BAUTISTA ARRIOLA",
            contact: "santiago.arriola.15@gmail.com / +52 921 52 58 693",
            website: "www.tudominio.com",
            version: "V11.0 CONNECTED"
        };

        const DB_KEY = 'pos_master_v11_connected';
        let db = {
            config: { company: '', address: '', phone: '', footer: '', taxRate: 0, currency: 'MXN', locale: 'es-MX', decimals: 2, logo: null },
            counters: { sales: 1, quotes: 1 },
            users: [{ id: 1, name: 'Admin', role: 'admin', pin: '1234' }],
            categories: ['General'],
            products: [{ id: 101, name: 'Prod. Ejemplo', category: 'General', price: 10, stock: 100, barcode: '' }],
            clients: [{ id: 0, name: 'P√∫blico General', balance: 0, phone: '' }],
            sales: [],
            quotations: [],
            shift: { isOpen: false, startTime: null, startCash: 0, cashier: null }
        };
        let currentUser=null, cart=[], selectedClient=null, payMethod='Efectivo', chartInstance=null, profileClient=null, invFilter='all';

        function init(){
            const s=localStorage.getItem(DB_KEY);
            if(s){
                try{
                    db={...db,...JSON.parse(s)};
                    if(!db.quotations) db.quotations=[];
                    if(!db.config) db.config={};
                    if(!db.config.company) document.getElementById('modal-setup').showModal();
                }catch(e){}
            }else{
                document.getElementById('modal-setup').showModal();
            }

            // Sincronizar UI de moneda/decimales/formato (si existe)
            const cur=document.getElementById('cfg-currency');
            const dec=document.getElementById('cfg-decimals');
            const loc=document.getElementById('cfg-locale');
            if(cur) cur.value = (db.config.currency||'MXN');
            if(dec) dec.value = String(Number.isInteger(db.config.decimals)?db.config.decimals:2);
            if(loc) loc.value = (db.config.locale||'es-MX');

            const applyCfg = ()=>{
                if(cur) db.config.currency = cur.value || db.config.currency;
                if(dec) db.config.decimals = parseInt(dec.value || db.config.decimals);
                if(loc) db.config.locale = loc.value || db.config.locale;
                saveDB();
                try{ updateCart(); }catch(e){}
                try{ updateDash(); }catch(e){}
            };
            if(cur) cur.onchange = applyCfg;
            if(dec) dec.onchange = applyCfg;
            if(loc) loc.onchange = applyCfg;

            updateBranding();
            initLogin();
            loadDevInfo();
        }
        function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function money(value){
  const cfg = db.config || {};
  const currency = cfg.currency || 'MXN';
  const locale = cfg.locale || 'es-MX';
  const decimals = Number.isInteger(cfg.decimals) ? cfg.decimals : 2;

  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency,
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }).format(Number(value) || 0);
}

        
        function updateBranding(){
            const c=db.config;
            if(c.logo){ ['settings-logo-preview'].forEach(id=>{ const el=document.getElementById(id); el.src=c.logo; el.classList.remove('hidden'); }); }
            document.getElementById('app-brand-name').innerText = c.company || 'POS MASTER';
        }

        function loadDevInfo() {
            document.getElementById('dev-info-content').innerHTML = `
                <p><strong>Desarrollador:</strong> ${DEV_INFO.name}</p>
                <p><strong>Contacto:</strong> ${DEV_INFO.contact}</p>
                <p><strong>Web:</strong> ${DEV_INFO.website}</p>
                <p><strong>Versi√≥n:</strong> ${DEV_INFO.version}</p>
            `;
        }

        function initLogin(){
            const g=document.getElementById('user-grid');
            g.innerHTML='';
            db.users.forEach(u=>{
                g.innerHTML+=`<button onclick='selectUser(${JSON.stringify(u)})' class="glass-btn p-4 rounded-xl flex flex-col items-center gap-2 hover:bg-white/10"><div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 font-bold text-xl">${u.name[0]}</div><span class="font-bold">${u.name}</span></button>`;
            });

            // Mejor UX en m√≥vil: solo n√∫meros + Enter para acceder
            const pin=document.getElementById('login-pin');
            if(pin){
                pin.oninput = () => { pin.value = String(pin.value||'').replace(/\D/g,'').slice(0,4); };
                pin.onkeyup = (e) => { if(e.key === 'Enter') attemptLogin(); };
            }
        }
        let tempUser=null; function selectUser(u){ tempUser=u; document.getElementById('user-grid').classList.add('hidden'); document.getElementById('pin-container').classList.remove('hidden'); document.getElementById('login-user-name').innerText=u.name; document.getElementById('login-pin').focus(); }
        function resetLogin(){ tempUser=null; document.getElementById('user-grid').classList.remove('hidden'); document.getElementById('pin-container').classList.add('hidden'); document.getElementById('login-pin').value=''; }
        function attemptLogin(){ 
            if(!tempUser) return toast("Selecciona un usuario","error");
            if(document.getElementById('login-pin').value===tempUser.pin){ 
                currentUser=tempUser; document.getElementById('login-screen').classList.add('hidden'); 
                document.getElementById('main-header').classList.remove('hidden'); document.getElementById('main-container').classList.remove('hidden'); 
                document.getElementById('main-container').classList.add('flex'); document.getElementById('header-user').innerText=currentUser.name; document.getElementById('header-role').innerText=currentUser.role; 
                selectedClient=db.clients[0]; nav('home'); checkShiftStatus(); 
            }else{ toast("PIN Incorrecto","error"); document.getElementById('login-pin').value=''; } 
        }
        function checkShiftStatus(){ if(!db.shift.isOpen){ document.getElementById('modal-shift-open').showModal(); } }
        function startShift(){ const amount = parseFloat(document.getElementById('shift-start-amount').value); if(isNaN(amount)) return toast("Ingresa monto v√°lido","error"); db.shift = { isOpen: true, startTime: new Date().toISOString(), startCash: amount, cashier: currentUser.name }; db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); document.getElementById('modal-shift-open').close(); toast("Turno Abierto"); updateDash(); }
        function performCashCut(){
            if(!db.shift.isOpen) return toast("No hay turno abierto","error");
            const startTime = new Date(db.shift.startTime).getTime();
            const shiftSales = db.sales.filter(s => new Date(s.date).getTime() >= startTime && s.method === 'Efectivo');
            const cashTotal = shiftSales.reduce((a,b)=>a+b.total,0);
            const expected = db.shift.startCash + cashTotal;
            document.getElementById('cut-start').innerText = `${money(db.shift.startCash)}`;
            document.getElementById('cut-sales').innerText = `${money(cashTotal)}`;
            document.getElementById('cut-expected').innerText = `${money(expected)}`;
            document.getElementById('cut-expected').dataset.val = expected;
            document.getElementById('modal-shift-close').showModal();
        }
        function calcDiff(){ const expected = parseFloat(document.getElementById('cut-expected').dataset.val); const counted = parseFloat(document.getElementById('cut-counted').value) || 0; const diff = counted - expected; const box = document.getElementById('cut-diff-box'); box.innerText = `Diferencia: ${money(diff)}`; box.classList.remove('hidden','bg-emerald-500/20','bg-rose-500/20','text-emerald-400','text-rose-400'); box.classList.add(diff >= 0 ? 'bg-emerald-500/20' : 'bg-rose-500/20', diff >= 0 ? 'text-emerald-400' : 'text-rose-400'); }
        function confirmCut(){
            const counted = parseFloat(document.getElementById('cut-counted').value) || 0;
            const expected = parseFloat(document.getElementById('cut-expected').dataset.val);
            const closeData = { ...db.shift, endTime: new Date().toISOString(), expected, counted, diff: counted - expected };
            printZReport(closeData);
            db.shift = { isOpen: false, startTime: null, startCash: 0, cashier: null }; db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); document.getElementById('modal-shift-close').close(); location.reload();
        }

        // --- IMPRESI√ìN IFRAME ---
        function printZReport(data){
            const html = `
                <style>@page { size: letter; margin: 1cm; } body { font-family: sans-serif; } .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; } .row { display: flex; justify-content: space-between; margin-bottom: 10px; } .bold { font-weight: bold; } .big { font-size: 1.2em; }</style>
                <div class="header"><h1>CORTE DE CAJA (Z)</h1><p>${db.config.company}</p><p>${new Date(data.startTime).toLocaleString()} - ${new Date(data.endTime).toLocaleString()}</p><p>Cajero: ${data.cashier}</p></div>
                <div class="row"><span>Fondo Inicial:</span><span>${money(data.startCash)}</span></div>
                <div class="row"><span>Ventas Efectivo:</span><span>${money((data.expected - data.startCash))}</span></div>
                <hr>
                <div class="row bold big"><span>Total Esperado:</span><span>${money(data.expected)}</span></div>
                <div class="row"><span>Real en Caja:</span><span>${money(data.counted)}</span></div>
                <div class="row bold" style="color:${data.diff>=0?'green':'red'}"><span>Diferencia:</span><span>${money(data.diff)}</span></div>
                <br><br><div style="text-align:center; margin-top:50px;">_________________________<br>Firma</div>
            `;
            printToIframe(html);
        }

        function printTicket(data, isQuote = false) {
            const conf = db.config;
            const logoHtml = conf.logo ? `<img src="${conf.logo}" style="max-height:60px; display:block; margin:0 auto 10px;">` : '';
            let html = '', css = '';

            if(isQuote) {
                css = `@page { size: letter; margin: 2cm; } body { font-family: sans-serif; color: #333; } .header { display: flex; justify-content: space-between; border-bottom: 2px solid #3b82f6; padding-bottom: 20px; margin-bottom: 20px; } .company h1 { margin: 0; color: #1e3a8a; } table { width: 100%; border-collapse: collapse; } th { background: #f1f5f9; padding: 10px; text-align: left; } td { padding: 10px; border-bottom: 1px solid #e2e8f0; } .total { text-align: right; font-size: 1.5em; font-weight: bold; margin-top: 20px; color: #1e3a8a; }`;
                html = `
                    <div class="header"><div class="company">${logoHtml}<h1>${conf.company}</h1><p>${conf.address}</p><p>${conf.phone}</p></div><div style="text-align:right"><h2>COTIZACI√ìN #${data.id}</h2><p>${new Date(data.date).toLocaleDateString()}</p></div></div>
                    <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:20px;"><p><strong>Cliente:</strong> ${data.client}</p></div>
                    <table><thead><tr><th>Cant</th><th>Descripci√≥n</th><th style="text-align:right">P. Unit</th><th style="text-align:right">Importe</th></tr></thead><tbody>
                    ${data.items.map(i=>`<tr><td>${i.qty}</td><td>${i.name}</td><td style="text-align:right">${money(i.price)}</td><td style="text-align:right">${money((i.price*i.qty))}</td></tr>`).join('')}
                    </tbody></table>
                    <div class="total">TOTAL: ${money(data.total)}</div>
                    <div style="text-align:center; margin-top:50px; font-size:0.8em; color:#94a3b8;">${conf.footer}<br>Precios sujetos a cambio. V√°lido 15 d√≠as.</div>
                `;
            } else {
                css = `@page { margin: 0; size: 80mm auto; } body { font-family: monospace; width: 72mm; margin: 0 auto; padding: 5px; color: black; } .center { text-align: center; } .row { display: flex; justify-content: space-between; }`;
                html = `
                    <div class="center">${logoHtml}<h3>${conf.company}</h3><p>${conf.address}</p><p>${conf.phone}</p></div>
                    <div style="border-bottom:1px dashed #000; margin: 5px 0;"></div>
                    <div>Folio: ${data.id}<br>${new Date(data.date).toLocaleString()}</div>
                    <div style="border-bottom:1px dashed #000; margin: 5px 0;"></div>
                    ${data.items.map(i=>`<div class="row"><span>${i.qty} ${i.name}</span><span>${money((i.price*i.qty))}</span></div>`).join('')}
                    <div style="border-bottom:1px dashed #000; margin: 5px 0;"></div>
                    <div class="row" style="font-weight:bold; font-size:1.2em;"><span>TOTAL</span><span>${money(data.total)}</span></div>
                    <div class="center" style="margin-top:10px; font-size:0.8em;">${conf.footer}</div>
                `;
            }
            printToIframe(html, css);
        }

        function printToIframe(html, css = '') {
            let iframe = document.getElementById('print-frame');
            if(!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'print-frame';
                document.body.appendChild(iframe);
            }
            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write(`<html><head><style>${css}</style></head><body>${html}</body></html>`);
            doc.close();
            setTimeout(() => { iframe.contentWindow.focus(); iframe.contentWindow.print(); }, 500);
        }

        // --- POS CORE ---
        function handleBarcode(e){ if(e.key==='Enter'){ const t=e.target.value.toLowerCase().trim(); if(!t)return; const p=db.products.find(x=>x.barcode===t || x.name.toLowerCase()===t); if(p){ addToCart(p); e.target.value=''; toast(`Agregado: ${p.name}`); }else{ toast("No encontrado","error"); } } }
        function renderPOS(){ const g=document.getElementById('pos-grid'); g.innerHTML=''; const s=document.getElementById('pos-search').value.toLowerCase(); const activeCat=window.currentCat||'Todos'; 
            document.getElementById('category-filters').innerHTML=`<button onclick="window.currentCat='Todos';renderPOS()" class="glass-btn px-4 h-full rounded-xl text-xs font-bold ${activeCat==='Todos'?'bg-blue-600 border-blue-500':''}">Todos</button>`+db.categories.map(c=>`<button onclick="window.currentCat='${c}';renderPOS()" class="glass-btn px-4 h-full rounded-xl text-xs font-bold ${activeCat===c?'bg-blue-600 border-blue-500':''}">${c}</button>`).join('');
            db.products.filter(p=>(activeCat==='Todos'||p.category===activeCat) && (p.name.toLowerCase().includes(s)||p.barcode?.includes(s))).forEach(p=>{ g.innerHTML+=`<div onclick='addToCart(${JSON.stringify(p)})' class="glass-btn p-3 rounded-2xl flex flex-col justify-between text-left group hover:border-blue-500/50 transition relative overflow-hidden"><div class="absolute right-0 top-0 p-2 opacity-50 text-[10px] font-mono">${p.stock}</div><div class="font-bold text-sm leading-tight mb-2 pr-4">${p.name}</div><div class="text-blue-400 font-black text-xl">${money(p.price)}</div></div>`; }); 
            updateCart();
        }
        function addToCart(p){ if(p.stock<=0) return toast("Sin Stock","error"); const ex=cart.find(i=>i.id===p.id); if(ex){ if(ex.qty>=p.stock) return toast("Max Stock","error"); ex.qty++; }else{ cart.push({...p,qty:1}); } updateCart(); }
        function updateCart(){ 
            const l=document.getElementById('pos-cart-list'); l.innerHTML=''; let sub=0; 
            cart.forEach((i,x)=>{ sub+=i.price*i.qty; l.innerHTML+=`<div class="flex justify-between items-center bg-white/5 p-3 rounded-xl text-sm group hover:bg-white/10 transition mb-2 border border-white/5"><div class="flex-1 overflow-hidden mr-2"><div class="truncate font-bold">${i.name}</div><div class="text-xs opacity-50 font-mono">${i.qty} x ${money(i.price)}</div></div><div class="flex items-center gap-3"><span class="font-bold text-lg font-mono">${money((i.price*i.qty))}</span><button onclick="cart.splice(${x},1);updateCart()" class="text-rose-400 hover:text-rose-300 bg-rose-500/10 p-2 rounded-lg transition"><i class="ph-bold ph-trash"></i></button></div></div>`; });
            const tax = sub * ((db.config.taxRate||0)/100);
            document.getElementById('lbl-subtotal').innerText=`${money(sub)}`; document.getElementById('lbl-tax').innerText=`${money(tax)}`;
            document.getElementById('lbl-total').innerText=`${money((sub+tax))}`; document.getElementById('modal-pay-total').innerText=`${money((sub+tax))}`;
            document.getElementById('pos-client-name').innerText=selectedClient.name;
        }
        function openPaymentModal(){ if(cart.length===0) return toast("Carrito vac√≠o","error"); document.getElementById('modal-payment').showModal(); }
        function setPayMethod(m){ payMethod=m; ['Efectivo','Tarjeta','Transferencia','Cr√©dito'].forEach(x=>{ const b=document.getElementById('btn-pay-'+x); if(x===m){ b.classList.add('border-blue-500','bg-blue-500/10'); }else{ b.classList.remove('border-blue-500','bg-blue-500/10'); } }); }
        
        function confirmSale(){
            if(payMethod==='Cr√©dito' && selectedClient.id===0) return toast("Selecciona Cliente","error");
            let sub=0; cart.forEach(i=>sub+=i.price*i.qty); const tax=sub*((db.config.taxRate||0)/100); const total=sub+tax;
            cart.forEach(i=>{ const p=db.products.find(x=>x.id===i.id); if(p) p.stock-=i.qty; });
            if(payMethod==='Cr√©dito'){ const idx=db.clients.findIndex(c=>c.id===selectedClient.id); if(idx!==-1) db.clients[idx].balance=(db.clients[idx].balance||0)+total; }
            const sale = { id: db.counters.sales++, date: new Date().toISOString(), client: selectedClient.name, clientId: selectedClient.id, items:[...cart], sub, tax, total, method: payMethod, cashier: currentUser.name };
            db.sales.push(sale); db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); printTicket(sale); cart=[]; updateCart(); document.getElementById('modal-payment').close(); renderPOS(); toast("Venta Exitosa");
        }
        function processQuotation(){
            if(cart.length===0) return toast("Carrito vac√≠o","error");
            let sub=0; cart.forEach(i=>sub+=i.price*i.qty); const tax=sub*((db.config.taxRate||0)/100); const total=sub+tax;
            const quote = { id: db.counters.quotes++, date: new Date().toISOString(), client: selectedClient.name, clientId: selectedClient.id, items:[...cart], sub, tax, total, cashier: currentUser.name };
            db.quotations.push(quote); db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); printTicket(quote, true); toast("Cotizaci√≥n Generada");
        }

        // --- CLIENTES CONEXI√ìN TOTAL (NEW) ---
        function openClientSelectionModal() {
            renderClientSelect(''); // Cargar todos al abrir
            document.getElementById('modal-client-select').showModal();
        }

        function renderClientSelect(query) {
            const list = document.getElementById('client-select-list');
            list.innerHTML = '';
            
            // Filtrar clientes
            const filtered = db.clients.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));

            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center opacity-50 p-4">No se encontraron clientes</div>`;
                return;
            }

            filtered.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 hover:bg-white/10 rounded-xl font-bold flex justify-between items-center group border-b border-white/5 transition";
                btn.innerHTML = `
                    <div>
                        <div class="text-sm">${c.name}</div>
                        <div class="text-xs opacity-50 font-mono">${c.phone || 'Sin Tel√©fono'}</div>
                    </div>
                    <i class="ph-bold ph-caret-right opacity-0 group-hover:opacity-100 text-blue-400 transition-opacity"></i>
                `;
                // Asignar funci√≥n segura al clic
                btn.onclick = () => selectClientForSale(c.id);
                list.appendChild(btn);
            });
        }

        function selectClientForSale(id) {
            const client = db.clients.find(c => c.id === id);
            if (client) {
                selectedClient = client;
                // Actualizar UI
                document.getElementById('pos-client-name').innerText = client.name;
                document.getElementById('modal-client-select').close();
                toast(`Cliente asignado: ${client.name}`);
            }
        }

        function submitNewClient(e){ 
            e.preventDefault(); 
            const newClient = { 
                id: Date.now(), 
                name: document.getElementById('new-client-name').value, 
                phone: document.getElementById('new-client-phone').value, 
                email: document.getElementById('new-client-email').value, 
                balance: 0 
            };
            db.clients.push(newClient); 
            db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); 
            
            // Auto-seleccionar el nuevo cliente para la venta actual
            selectedClient = newClient;
            document.getElementById('pos-client-name').innerText = newClient.name;
            
            toast("Cliente Creado y Seleccionado"); 
            document.getElementById('modal-client-add').close(); 
            renderClients(); 
        }

        function openClientProfile(id){ profileClient=db.clients.find(x=>x.id===id); if(!profileClient)return; document.getElementById('profile-client-name').innerText=profileClient.name; document.getElementById('profile-client-phone').innerText=profileClient.phone||'--'; document.getElementById('profile-client-email').innerText=profileClient.email||'--'; document.getElementById('profile-client-debt').innerText=`${money((profileClient.balance||0))}`; document.getElementById('modal-client-profile').showModal(); switchTab('sales'); }
        function switchTab(t){ 
            ['sales','quotes','credit'].forEach(x=>{ document.getElementById('tab-'+x).classList.remove('tab-active'); document.getElementById('content-'+x).classList.add('hidden'); }); 
            document.getElementById('tab-'+t).classList.add('tab-active'); document.getElementById('content-'+t).classList.remove('hidden'); 
            if(t==='sales')renderProfileList(db.sales, 'content-sales', false); 
            if(t==='quotes')renderProfileList(db.quotations, 'content-quotes', true); 
        }
        function renderProfileList(src, elId, isQuote){ const l=document.getElementById(elId); l.innerHTML=''; const items=src.filter(x=>x.clientId===profileClient.id).reverse(); if(items.length===0) l.innerHTML='<div class="text-center opacity-30 mt-10">Sin registros</div>'; items.forEach(x=>{ const json=JSON.stringify(x).replace(/"/g,'&quot;'); l.innerHTML+=`<div class="bg-white/5 p-3 rounded-xl flex justify-between items-center mb-2"><div class="text-sm"><span class="font-bold">#${x.id}</span> <span class="opacity-50">${new Date(x.date).toLocaleDateString()}</span><br><span class="text-xs opacity-50">${x.items.length} items</span></div><div class="flex items-center gap-3"><span class="font-bold ${isQuote?'text-orange-400':'text-blue-400'}">${money(x.total)}</span><button onclick="printTicket(JSON.parse('${json}'),${isQuote})" class="glass-btn p-2 rounded"><i class="ph-bold ph-printer"></i></button></div></div>`; }); }
        function adjustCredit(act){ const v=parseFloat(document.getElementById('credit-amount').value); if(!v)return; const i=db.clients.findIndex(c=>c.id===profileClient.id); if(i===-1)return; if(act==='add') db.clients[i].balance=(db.clients[i].balance||0)+v; if(act==='pay') db.clients[i].balance=(db.clients[i].balance||0)-v; if(db.clients[i].balance<0) db.clients[i].balance=0; db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); openClientProfile(db.clients[i].id); renderClients(); }
        function sendWhatsApp(type) { if(!profileClient.phone) return toast("Sin tel√©fono","error"); const p=profileClient.phone.replace(/[^0-9]/g, ''); let m=""; if(type==='debt'){ m=`Hola ${profileClient.name}, recordatorio de pago pendiente: ${money((profileClient.balance||0))} en ${db.config.company}.`; }else{ m=`Hola ${profileClient.name}, tenemos nuevas ofertas en ${db.config.company}. ¬°Vis√≠tanos!`; } window.open(`https://wa.me/${p}?text=${encodeURIComponent(m)}`,'_blank'); }
        
        // --- EDICI√ìN CLIENTE ---
        function openEditClientModal(){
            if(!profileClient) return;
            document.getElementById('edit-client-name').value = profileClient.name;
            document.getElementById('edit-client-phone').value = profileClient.phone || '';
            document.getElementById('edit-client-email').value = profileClient.email || '';
            document.getElementById('modal-client-edit').showModal();
        }
        function saveEditClient(e){
            e.preventDefault();
            const idx = db.clients.findIndex(c => c.id === profileClient.id);
            if(idx !== -1){
                db.clients[idx].name = document.getElementById('edit-client-name').value;
                db.clients[idx].phone = document.getElementById('edit-client-phone').value;
                db.clients[idx].email = document.getElementById('edit-client-email').value;
                db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB();
                profileClient = db.clients[idx];
                document.getElementById('profile-client-name').innerText = profileClient.name;
                document.getElementById('profile-client-phone').innerText = profileClient.phone || '--';
                document.getElementById('profile-client-email').innerText = profileClient.email || '--';
                if(selectedClient && selectedClient.id === profileClient.id) { selectedClient = profileClient; document.getElementById('pos-client-name').innerText = profileClient.name; }
                renderClients();
                document.getElementById('modal-client-edit').close();
                toast("Cliente Actualizado");
            }
        }

        // --- UTILS ---
        function renderInventory(){
            const list=document.getElementById('inventory-list'); list.innerHTML='';
            let items = [...db.products];
            if(invFilter === 'low') items = items.filter(p => p.stock <= 5);
            if(invFilter === 'top') { const counts = {}; db.sales.forEach(s => s.items.forEach(i => counts[i.id] = (counts[i.id] || 0) + i.qty)); items.sort((a,b) => (counts[b.id]||0) - (counts[a.id]||0)); }
            items.forEach(p=>{ list.innerHTML += `<tr class="hover:bg-white/5 border-b border-white/5"><td class="p-4 pl-6 font-bold flex items-center gap-3"><div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center text-xs text-slate-400"><i class="ph-bold ph-package"></i></div> ${p.name}</td><td class="text-xs opacity-50 font-mono">${p.barcode||'--'}</td><td><span class="bg-blue-500/10 text-blue-400 px-2 py-1 rounded text-xs uppercase font-bold">${p.category}</span></td><td class="text-center font-bold ${p.stock<=5?'text-rose-400':'text-slate-200'}">${p.stock}</td><td class="text-right opacity-50 text-xs">${money((p.price-5))}</td><td class="text-right font-bold text-emerald-400">${money(p.price)}</td><td class="text-right pr-6"><button onclick='openProductModal(${JSON.stringify(p)})' class="p-2 hover:bg-white/10 rounded-lg text-blue-400"><i class="ph-bold ph-pencil-simple"></i></button></td></tr>`; });
        }
        function updateDash(){ 
            const t=new Date().toLocaleDateString(); const todaySales=db.sales.filter(s=>new Date(s.date).toLocaleDateString()===t);
            document.getElementById('dash-sales-today').innerText = money(todaySales.reduce((a,b)=>a+b.total,0));
            document.getElementById('dash-start-cash').innerText = money((db.shift.startCash||0));
            document.getElementById('dash-tx-count').innerText=todaySales.length;
            const log=document.getElementById('recent-sales-log'); log.innerHTML=''; todaySales.reverse().forEach(s=>{ log.innerHTML+=`<div class="flex justify-between p-2 hover:bg-white/5 rounded"><span>#${s.id}</span><span>${money(s.total)}</span></div>` });
        }
        function renderChart(){ const ctx=document.getElementById('salesChart').getContext('2d'); if(chartInstance)chartInstance.destroy(); const days=Array.from({length:7},(_,i)=>{const d=new Date(); d.setDate(d.getDate()-i); return d;}).reverse(); const data=days.map(d=>{ const ds=d.toLocaleDateString(); return db.sales.filter(s=>new Date(s.date).toLocaleDateString()===ds).reduce((a,b)=>a+b.total,0); }); chartInstance=new Chart(ctx,{type:'bar',data:{labels:days.map(d=>d.getDate()+'/'+(d.getMonth()+1)),datasets:[{label:'Ventas',data,backgroundColor:document.body.classList.contains('light-mode')?'#2563eb':'#3b82f6',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{color:'#94a3b8'}},y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#94a3b8'}}}}}); }
        function backupSmart(){ const b=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`POS_DATA_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function downloadTemplate(){ window.open('data:text/csv;charset=utf-8,Nombre,Categoria,Precio,Stock,Codigo%0AProducto A,General,10.50,100,750123','_blank'); }
        function processCSV(input){ const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ const rows=e.target.result.split('\n').slice(1); let c=0; rows.forEach(r=>{ const col=r.split(','); if(col.length>=4){ const n=col[0]?.trim(); if(n){ db.products.push({id:Date.now()+Math.random(),name:n,category:col[1]||'General',price:parseFloat(col[2])||0,stock:parseInt(col[3])||0,barcode:col[4]?.trim()||''}); c++; } } }); db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); toast(`Importados ${c} productos`); }; r.readAsText(f); }
        function importDB(input){ const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{db=JSON.parse(e.target.result); db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); location.reload();}catch(x){toast("Error Archivo","error")} }; r.readAsText(f); }
        function saveSettings(){ db.config.company=document.getElementById('cfg-company').value; db.config.phone=document.getElementById('cfg-phone').value; db.config.address=document.getElementById('cfg-address').value; db.config.footer=document.getElementById('cfg-footer').value; db.config.taxRate=parseFloat(document.getElementById('cfg-tax').value)||0; db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); updateBranding(); toast("Guardado"); }
        function loadSettings(){
            const c=db.config||{};
            document.getElementById('cfg-company').value=c.company||'';
            document.getElementById('cfg-phone').value=c.phone||'';
            document.getElementById('cfg-address').value=c.address||'';
            document.getElementById('cfg-footer').value=c.footer||'';
            document.getElementById('cfg-tax').value=c.taxRate||0;

            // Si existen (en modal de cliente o en ajustes), reflejar moneda/decimales/formato
            const cur=document.getElementById('cfg-currency'); if(cur) cur.value=c.currency||'MXN';
            const dec=document.getElementById('cfg-decimals'); if(dec) dec.value=String(Number.isInteger(c.decimals)?c.decimals:2);
            const loc=document.getElementById('cfg-locale'); if(loc) loc.value=c.locale||'es-MX';

            renderMiniUsers();
        }
        function processLogoUpload(input){ const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ db.config.logo=e.target.result; db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); updateBranding(); toast("Logo actualizado"); }; r.readAsDataURL(f); }
        function renderMiniUsers(){ const l=document.getElementById('users-list-mini'); l.innerHTML=''; db.users.forEach(u=>{ l.innerHTML+=`<div class="flex justify-between items-center bg-white/5 p-2 rounded text-xs"><span>${u.name} (${u.role})</span><button onclick='openUserModal(${JSON.stringify(u)})' class="text-blue-400 font-bold">Edit</button></div>`; }); }
        function nav(v){ if(currentUser.role!=='admin' && (v==='settings'||v==='reports')) return toast("Acceso Denegado","error"); document.querySelectorAll('[id^="view-"]').forEach(e=>e.classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); if(v==='pos') renderPOS(); if(v==='inventory'){renderInventory();renderCatList();} if(v==='clients') renderClients(); if(v==='reports'){updateDash();renderChart();} if(v==='settings') loadSettings(); }
        function toast(m,t){ const el=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; document.getElementById('toast-title').innerText=t==='error'?'Error':'Info'; document.getElementById('toast-icon').className=t==='error'?'ph-fill ph-warning-circle text-orange-400':'ph-fill ph-check-circle text-blue-400'; el.classList.remove('translate-x-[200%]'); setTimeout(()=>el.classList.add('translate-x-[200%]'),3000); }
        function updateClock(){ const d=new Date(); document.getElementById('clock-time').innerText=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); document.getElementById('clock-date').innerText=d.toLocaleDateString([],{weekday:'short',day:'numeric',month:'short'}); }
        function toggleTheme(){ document.body.classList.toggle('light-mode'); }
        function saveWizard(e){ e.preventDefault(); db.config.company=document.getElementById('wiz-name').value; db.config.address=document.getElementById('wiz-addr').value; db.config.phone=document.getElementById('wiz-phone').value; db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); document.getElementById('modal-setup').close(); updateBranding(); }
        function saveProductForm(e){ e.preventDefault(); const id=document.getElementById('inp-prod-id').value; const p={id:id?parseFloat(id):Date.now(),name:document.getElementById('inp-prod-name').value,barcode:document.getElementById('inp-prod-code').value,category:document.getElementById('inp-prod-cat').value,price:parseFloat(document.getElementById('inp-prod-price').value),stock:parseInt(document.getElementById('inp-prod-stock').value)}; if(id){ const i=db.products.findIndex(x=>x.id==id); db.products[i]=p; }else{ db.products.push(p); } db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); document.getElementById('modal-product').close(); renderInventory(); toast("Guardado"); }
        function openProductModal(p){ const s=document.getElementById('inp-prod-cat'); s.innerHTML=db.categories.map(c=>`<option value="${c}">${c}</option>`); if(p){ document.getElementById('inp-prod-id').value=p.id; document.getElementById('inp-prod-name').value=p.name; document.getElementById('inp-prod-code').value=p.barcode||''; document.getElementById('inp-prod-price').value=p.price; document.getElementById('inp-prod-stock').value=p.stock; }else{ document.getElementById('inp-prod-id').value=''; document.getElementById('inp-prod-name').value=''; document.getElementById('inp-prod-code').value=''; document.getElementById('inp-prod-price').value=''; document.getElementById('inp-prod-stock').value=''; } document.getElementById('modal-product').showModal(); }
        function submitUserForm(e){ e.preventDefault(); const id=document.getElementById('inp-user-id').value; const u={id:id?parseFloat(id):Date.now(),name:document.getElementById('inp-user-name').value,role:document.getElementById('inp-user-role').value,pin:document.getElementById('inp-user-pin').value}; if(id){ const i=db.users.findIndex(x=>x.id==id); db.users[i]=u; }else{ db.users.push(u); } db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); document.getElementById('modal-user').close(); loadSettings(); toast("Usuario Guardado"); }
        function openUserModal(u){ if(u){document.getElementById('inp-user-id').value=u.id;document.getElementById('inp-user-name').value=u.name;document.getElementById('inp-user-pin').value=u.pin;}else{document.getElementById('inp-user-id').value='';document.getElementById('inp-user-name').value='';document.getElementById('inp-user-pin').value='';} document.getElementById('modal-user').showModal(); }
        function addNewCategory(){ const n=document.getElementById('new-cat-name').value; if(n){ db.categories.push(n); db.config.currency = document.getElementById('cfg-currency')?.value || db.config.currency;
db.config.decimals = parseInt(document.getElementById('cfg-decimals')?.value ?? db.config.decimals);
db.config.locale = document.getElementById('cfg-locale')?.value || db.config.locale;
saveDB(); renderCatList(); document.getElementById('new-cat-name').value=''; } }
        function renderCatList(){ document.getElementById('cat-list-ui').innerHTML=db.categories.map(c=>`<div class="bg-white/5 p-2 rounded mb-1 font-bold">${c}</div>`).join(''); }
        function openClientAddModal(){ document.getElementById('modal-client-add').showModal(); }
        
        function renderClients(){ 
            const g=document.getElementById('clients-grid'); g.innerHTML=''; 
            db.clients.forEach(c=>{ 
                const d=c.balance||0; 
                g.innerHTML+=`<div onclick="openClientProfile(${c.id})" class="glass-panel p-4 cursor-pointer hover:bg-white/5"><div class="flex justify-between mb-2"><h4 class="font-bold">${c.name}</h4><span class="text-xs opacity-50 font-mono">${c.phone||''}</span></div><div class="text-right ${d>0?'text-rose-400':'text-emerald-400'} font-bold">${money(d)}</div></div>`; 
            }); 
        }

        setInterval(updateClock,1000);
        init();
        if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>
